<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<title>Speed Dating</title>

	<!--Libraries-->
  <script src="library/d3/d3.min.js" charset="utf-8"></script>
  <script src="library/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
  <script src="library/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>

    <!--Stylesheets-->
    <link rel="stylesheet" type="text/css" href="library/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/styles.css">

  <!--Font-->
  <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>

  <!-- vis classes-->
  <script src = "js/prefvis.js"></script>
  <script src = "js/nodevis.js"></script>

</head>
<body>
	<div class="col-md-12" id="prefVis">
	</div>

	<div class="col-md-9" id="nodevis" style="background:lightblue">
		<div class="dropdown dropdown-dark">
			<select name="two" class="dropdown-select" onchange="changewave(value)">
				<option value="">Wave</option>
				<option value="1">1</option>
				<option value="2">2</option>
				<option value="3">3</option>
				<option value="4">4</option>
				<option value="5">5</option>
				<option value="6">6</option>
				<option value="7">7</option>
				<option value="8">8</option>
				<option value="9">9</option>
				<option value="10">10</option>
				<option value="11">11</option>
				<option value="12">12</option>
				<option value="13">13</option>
				<option value="14">14</option>
				<option value="15">15</option>
				<option value="16">16</option>
				<option value="17">17</option>
				<option value="18">18</option>
				<option value="19">19</option>
				<option value="20">20</option>
				<option value="21">21</option>
			</select>
		</div>
  </div>


	<script>

	  $(function(){ 

      var allData = [];
     
      // call this function after Data is loaded, reformatted and bound to the variables
      var initVis = function(){

      	var MyEventHandler = new Object();

	     	var pref_vis = new PrefVis(d3.select("#prefVis"), allData);
	     	node_vis = new NodeVis(d3.select("#nodevis"), allData, MyEventHandler);

	     	$(MyEventHandler).bind("nodeclick", function(event, node){
	     		console.log(node)
	     	})

      }
      
      // call this function after both files are loaded -- error should be "null" if no error
			var dataLoaded = function (error, datingdata) {

			  if (!error) {

				  var attrs = ['attr','sinc','intel','fun','amb','shar'];

				  function copy(source, target, prefix, suffix) {
					  attrs.forEach(function(attr) {
						  var key = attr+prefix+'_'+suffix;
						  if (source.hasOwnProperty(key)) { // copy if the property exists
							  target[key] = source[key];
						  }
					  });
				  }

				  // to unique iid entries
				  var uniquedata = d3.map(datingdata, function(d) { return d.iid; }).values();
				  var data = uniquedata.map(function(d) {
						var temp = {
							iid: d.iid,
							age: d.age,
							gender: d.gender,
							race: d.race,
							goal: d.goal,
							career_c: d.career_c,
							wave: d.wave,
							round: d.round,
							you_call: d.you_call,
							them_call: d.them_call,
							date_3: d.date_3,
							people : []
						};

					  temp.start_pref = {};
					  // what the person looks for in the opposite sex (100 points)
					  copy(d, temp.start_pref, 1, 1);
					  // what the person thinks the opposite sex looks for (100 points)
					  copy(d, temp.start_pref, 2, 1);
					  // how the person rate him/herself (scale 1-10)
					  copy(d, temp.start_pref, 3, 1);
					  // how the person thinks others perceive him/her (scale 1-10)
					  copy(d, temp.start_pref, 5, 1);

					  temp.half_pref = {};
					  // what the person looks for in the opposite sex (scale 1-10)
					  copy(d, temp.half_pref, 1, 's');
					  // how the person rate him/herself (scale 1-10)
					  copy(d, temp.half_pref, 3, 's');

					  temp.day_pref = {};
					  // what the person looks for in the opposite sex (100 points)
					  copy(d, temp.day_pref, 1, 2);
					  // what the person thinks the opposite sex looks for (100 points)
					  copy(d, temp.day_pref, 2, 2);
					  // how the person rate him/herself (scale 1-10)
					  copy(d, temp.day_pref, 3, 2);
					  // how the person thinks others perceive him/her (scale 1-10)
					  copy(d, temp.day_pref, 5, 2);
					  
					  temp.week_pref = {};
					  // what the person looks for in the opposite sex (100 points)
					  copy(d, temp.week_pref, 1, 3);
					  // what the person thinks the opposite sex looks for (scale 1-10)
					  copy(d, temp.week_pref, 2, 3);
					  // how the person rate him/herself (scale 1-10)
					  copy(d, temp.week_pref, 3, 3);
					  // how the person thinks others perceive him/her (scale 1-10)
					  copy(d, temp.week_pref, 5, 3);
					  
					  return temp;
					});

				var lookup = d3.map(data, function(d) { return d.iid; });

			  datingdata.forEach(function(d) {
					var temp = {
						wave: d.wave,
						iid: d.iid,
						order: d.order,
						pid: d.pid,
						match: d.match,
						samerace: d.samerace,
						age_o: d.age_o,
						race_o: d.race_o,
						pf_o_attr: d.pf_o_attr,
						dec_o: d.dec_o,
						attr_o: d.attr_o,
						dec: d.dec,
						attr: d.attr,
						sinc: d.sinc,
						intel: d.intel,
						fun: d.fun,
						amb: d.amb,
						shar: d.shar,
						like: d.like,
						prob: d.prob
					};

					// lookup the corresponding data entry and push the people
					lookup.get(temp.iid).people.push(temp);
				});

				// group by wave
			    allData = d3.nest()
			             .key(function(d) { return d.wave;})
			             .entries(data);

			    initVis();
			  }
			}

	var dataLoaded = function (error, datingdata) {

	  if (!error) {

			var data = []; 

	    for (var i = 0; i < datingdata.length; i++) {
	      var temp = {
	        iid: datingdata[i].iid,
	        id: datingdata[i].id,
	        age: datingdata[i].age,
	        gender: datingdata[i].gender,
	        race: datingdata[i].race, 
	        goal: datingdata[i].goal,
	        career_c: datingdata[i].career_c,
	        wave: datingdata[i].wave,
	        round: datingdata[i].round,
	        you_call: datingdata[i].you_call,
	        them_call: datingdata[i].them_call,
	        date_3: datingdata[i].date_3,

	        start_pref: {
	          // what the person looks for in the opposite sex (100 points)
	          attr1_1: datingdata[i].attr1_1,
	          sinc1_1: datingdata[i].sinc1_1,
	          intel1_1: datingdata[i].intel1_1,
	          fun1_1: datingdata[i].fun1_1,
	          amb1_1: datingdata[i].amb1_1,
	          shar1_1: datingdata[i].shar1_1,
	          // what the person thinks the opposite sex looks for (100 points)
	          attr2_1: datingdata[i].attr2_1,
	          sinc2_1: datingdata[i].sinc2_1,
	          intel2_1: datingdata[i].intel2_1,
	          fun2_1: datingdata[i].fun2_1,
	          amb2_1: datingdata[i].amb2_1,
	          shar2_1: datingdata[i].shar2_1,
	          // how the person rate him/herself (scale 1-10)
	          attr3_1: datingdata[i].attr3_1,
	          sinc3_1: datingdata[i].sinc3_1,
	          intel3_1: datingdata[i].intel3_1,
	          fun3_1: datingdata[i].fun3_1,
	          amb3_1: datingdata[i].amb3_1,
	          // how the person thinks others perceive him/her (scale 1-10)
	          attr5_1: datingdata[i].attr5_1,
	          sinc5_1: datingdata[i].sinc5_1,
	          intel5_1: datingdata[i].intel5_1,
	          fun5_1: datingdata[i].fun5_1,
	          amb5_1: datingdata[i].amb5_1
	        },

	        half_pref: {
	          // what the person looks for in the opposite sex (scale 1-10)
	          attr1_s: datingdata[i].attr1_s,
	          sinc1_s: datingdata[i].sinc1_s,
	          intel1_s: datingdata[i].intel1_s,
	          fun1_s: datingdata[i].fun1_s,
	          amb1_s: datingdata[i].amb1_s,
	          // how the person rate him/herself (scale 1-10)
	          attr3_s: datingdata[i].attr3_s,
	          sinc3_s: datingdata[i].sinc3_s,
	          intel3_s: datingdata[i].intel3_s,
	          fun3_s: datingdata[i].fun3_s,
	          amb3_s: datingdata[i].amb3_s
	        },

	        day_pref: {
	          // what the person looks for in the opposite sex (100 points)
	          attr1_2: datingdata[i].attr1_2,
	          sinc1_2: datingdata[i].sinc1_2,
	          intel1_2: datingdata[i].intel1_2,
	          fun1_2: datingdata[i].fun1_2,
	          amb1_2: datingdata[i].amb1_2,
	          shar1_2: datingdata[i].shar1_2,
	          // what the person thinks the opposite sex looks for (100 points)
	          attr2_2: datingdata[i].attr2_2,
	          sinc2_2: datingdata[i].sinc2_2,
	          intel2_2: datingdata[i].intel2_2,
	          fun2_2: datingdata[i].fun2_2,
	          amb2_2: datingdata[i].amb2_2,
	          shar2_2: datingdata[i].shar2_2,
	          // how the person rate him/herself (scale 1-10)
	          attr3_2: datingdata[i].attr3_2,
	          sinc3_2: datingdata[i].sinc3_2,
	          intel3_2: datingdata[i].intel3_2,
	          fun3_2: datingdata[i].fun3_2,
	          amb3_2: datingdata[i].amb3_2,
	          // how the person thinks others perceive him/her (scale 1-10)
	          attr5_2: datingdata[i].attr5_2,
	          sinc5_2: datingdata[i].sinc5_2,
	          intel5_2: datingdata[i].intel5_2,
	          fun5_2: datingdata[i].fun5_2,
	          amb5_2: datingdata[i].amb5_2
	        },

	        week_pref: {
	          // what the person looks for in the opposite sex (100 points)
	          attr1_3: datingdata[i].attr1_3,
	          sinc1_3: datingdata[i].sinc1_3,
	          intel1_3: datingdata[i].intel1_3,
	          fun1_3: datingdata[i].fun1_3,
	          amb1_3: datingdata[i].amb1_3,
	          shar1_3: datingdata[i].shar1_3,
	          // what the person thinks the opposite sex looks for (scale 1-10)
	          attr2_3: datingdata[i].attr2_3,
	          sinc2_3: datingdata[i].sinc2_3,
	          intel2_3: datingdata[i].intel2_3,
	          fun2_3: datingdata[i].fun2_3,
	          amb2_3: datingdata[i].amb2_3,
	          shar2_3: datingdata[i].shar2_3,
	          // how the person rate him/herself (scale 1-10)
	          attr3_3: datingdata[i].attr3_3,
	          sinc3_3: datingdata[i].sinc3_3,
	          intel3_3: datingdata[i].intel3_3,
	          fun3_3: datingdata[i].fun3_3,
	          amb3_3: datingdata[i].amb3_3,
	          // how the person thinks others perceive him/her (scale 1-10)
	          attr5_3: datingdata[i].attr5_3,
	          sinc5_3: datingdata[i].sinc5_3,
	          intel5_3: datingdata[i].intel5_3,
	          fun5_3: datingdata[i].fun5_3,
	          amb5_3: datingdata[i].amb5_3
	        },

	        people: []

	      }
	      data.push(temp);
	    }

	    var ratings = [];

	    for (var i = 0; i < datingdata.length; i++) {
	      var temp = {
	        wave: datingdata[i].wave,
	        iid: datingdata[i].iid,

	        order: datingdata[i].order,
	        pid: datingdata[i].pid,
	        match: datingdata[i].match,
	        samerace: datingdata[i].samerace,
	        
	        age_o: datingdata[i].age_o,
	        race_o: datingdata[i].race_o,
	        pf_o_attr: datingdata[i].pf_o_attr,
	        dec_o: datingdata[i].dec_o,
	        attr_o: datingdata[i].attr_o,
	        
	        dec: datingdata[i].dec,
	        attr: datingdata[i].attr,
	        sinc: datingdata[i].sinc,
	        intel: datingdata[i].intel,
	        fun: datingdata[i].fun,
	        amb: datingdata[i].amb,
	        shar: datingdata[i].shar,
	        like: datingdata[i].like,
	        prob: datingdata[i].prob,
	      }
	      ratings.push(temp);
	    }

	    for (var i = 0; i < data.length; i++) {
	      for (var j = 0; j < ratings.length; j++) {
	        if (data[i].iid == ratings[j].iid) {
	          data[i]["people"].push(ratings[j]);
	        }
	      }
	    }

	    var reformatted_data = [];
	    var j = 0;
	    reformatted_data.push(data[j]);

	    for (var i = 1; i < data.length; i++) {
	      if (data[i].iid != data[j].iid)
	        reformatted_data.push(data[i]);
	      j = i;
	    }

		  var attrs = ['attr','sinc','intel','fun','amb','shar'];
		  function copy(source, target, prefix, suffix) {
			  attrs.forEach(function(attr) {
				  var key = attr+prefix+'_'+suffix;
				  if (source.hasOwnProperty(key)) { //copy if the property exists
					  target[key] = source[key];
				  }
			  });
		  }
		  //to unique iid entries
		  var uniquedata = d3.map(datingdata, function(d) { return d.iid; }).values();

		  var data = uniquedata.map(function(d) {
				var temp = {
					iid: d.iid,
					age: d.age,
					gender: d.gender,
					race: d.race,
					goal: d.goal,
					career_c: d.career_c,
					wave: d.wave,
					round: d.round,
					you_call: d.you_call,
					them_call: d.them_call,
					date_3: d.date_3,

					people : []
				};
			  temp.start_pref = {};
			  // what the person looks for in the opposite sex (100 points)
			  copy(d, temp.start_pref, 1, 1);
			  // what the person thinks the opposite sex looks for (100 points)
			  copy(d, temp.start_pref, 2, 1);
			  // how the person rate him/herself (scale 1-10)
			  copy(d, temp.start_pref, 3, 1);
			  // how the person thinks others perceive him/her (scale 1-10)
			  copy(d, temp.start_pref, 5, 1);

			  temp.half_pref = {};
			  // what the person looks for in the opposite sex (scale 1-10)
			  copy(d, temp.half_pref, 1, 's');
			  // how the person rate him/herself (scale 1-10)
			  copy(d, temp.half_pref, 3, 's');

			  temp.day_pref = {};
			  // what the person looks for in the opposite sex (100 points)
			  copy(d, temp.day_pref, 1, 2);
			  // what the person thinks the opposite sex looks for (100 points)
			  copy(d, temp.day_pref, 2, 2);
			  // how the person rate him/herself (scale 1-10)
			  copy(d, temp.day_pref, 3, 2);

			  // how the person thinks others perceive him/her (scale 1-10)
			  copy(d, temp.day_pref, 5, 2);
			  temp.week_pref = {};
			  // what the person looks for in the opposite sex (100 points)
			  copy(d, temp.week_pref, 1, 3);
			  // what the person thinks the opposite sex looks for (scale 1-10)
			  copy(d, temp.week_pref, 2, 3);
			  // how the person rate him/herself (scale 1-10)
			  copy(d, temp.week_pref, 3, 3);
			  // how the person thinks others perceive him/her (scale 1-10)
			  copy(d, temp.week_pref, 5, 3);
			  return temp;
			});

		var lookup = d3.map(data, function(d) { return d.iid; });
	    datingdata.forEach(function(d) {
			var temp = {
				wave: d.wave,
				iid: d.iid,

				order: d.order,
				pid: d.pid,
				match: d.match,
				samerace: d.samerace,

				age_o: d.age_o,
				race_o: d.race_o,
				pf_o_attr: d.pf_o_attr,
				dec_o: d.dec_o,
				attr_o: d.attr_o,

				dec: d.dec,
				attr: d.attr,
				sinc: d.sinc,
				intel: d.intel,
				fun: d.fun,
				amb: d.amb,
				shar: d.shar,
				like: d.like,
				prob: d.prob
			};
			//lookup the corresponding data entry and push the people
			lookup.get(temp.iid).people.push(temp);
		});
		//group by wave
	    allData = d3.nest()
	             .key(function(d) { return d.wave;})
	             .entries(data);

	    //console.log(allData);

	    initVis();
	    }
	}

      var startHere = function(){
				queue()
    			.defer(d3.csv, 'data/SpeedDating.csv')
    			.await(dataLoaded);
      }
      startHere();
	  })

	  function changewave(value) {

	  	value -= 1;

		if (value !== "") {
			node_vis.wrangleData(value);
			node_vis.updateVis();
		}
	}

	</script>
</body>
</html>